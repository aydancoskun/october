title = "Credit"
url = "/account/credit/:status?0"
layout = "account"
hidden = "0"
==
<?php
//use \Stripe\Stripe;
use Illuminate\Http\Response;
function onInit(){
    header("Access-Control-Allow-Origin: https://js.stripe.com:443");
    header("Access-Control-Allow-Origin: https://api.stripe.com:443");
}
function onInfo1Off() {
    DB::table('oktick.users')->where('id', $this->session->user()->attributes['id'])->update(array('ok_help1_credit' => 0));
}
function onInfo1On() {
    DB::table('oktick.users')->where('id', $this->session->user()->attributes['id'])->update(array('ok_help1_credit' => 1));
}

function onStart()
{
    \Debugbar::info("Credit Page onStart()");
    if(Config::get('app.debug')==true){
        $this['StripePublishableKey']='pk_test_i0BnSwZKTGm1TSrTxyiJWFt6';
        $this_stripe_secret_key ='sk_test_5CyATtLZuofD31bgwGQHIHCX';
        $this['debug_card']="4242424242424242";
        $this['debug_year']="16";
        $this['debug_month']="12";
        $this['debug_cvc']="123";
        $d=true;
    } else {
        $d=false;
        $this['StripePublishableKey']='pk_live_nsHDHCb4OJwHNtEcla3BYlEz';
        $this_stripe_secret_key ='sk_live_C4dkHoob5l3P48BVT4G6gtOA';
        $this['StripePublishableKey']='pk_test_i0BnSwZKTGm1TSrTxyiJWFt6';
        $this_stripe_secret_key ='sk_test_5CyATtLZuofD31bgwGQHIHCX';
    }

    try {
        $user = $this->session->user()->attributes;
        $user_name = $user['name'];
        $user_surname = $user['surname'];
        $user_email = $user['email'];
        $user_company = $user['company'];
        $user_id = $user['id'];
        $amt1=50;$amt2=100;$amt3=250;$amt4=500;$amt5=5000;
        $pri1=15;$pri2=25 ;$pri3=55 ;$pri4=100;$pri5=1000;
        if( $user['ok_first_time_buyer'] ) {
            $this['iprice']  = array(1=>$pri1,2=>$pri2,3=>$pri3,4=>$pri4,5=>$pri5);
            $this['iamount'] = array(1=>$amt1,2=>$amt2,3=>$amt3,4=>$amt4,5=>$amt5);
            $amt1=50;$amt2=200;$amt3=500;$amt4=1000;$amt5=10000;
            $pri1=0;$pri2=25 ;$pri3=55 ;$pri4=100;$pri5=1000;
            $this['initial']=true;
        } else {
            $this['initial']=false;
        }
        $this['price']=array(1=>$pri1,2=>$pri2,3=>$pri3,4=>$pri4,5=>$pri5);
        $this['amount']=array(1=>$amt1,2=>$amt2,3=>$amt3,4=>$amt4,5=>$amt5);
    }
    catch(Exception $e) {
        return Redirect::to("/login", 302);
    }
    
    $credit[$pri1 * 100]=$amt1;
    $credit[$pri2 * 100]=$amt2;
    $credit[$pri3 * 100]=$amt3;
    $credit[$pri4 * 100]=$amt4;
    $credit[$pri5 * 100]=$amt5;
    $error = "Sorry, something went wrong. Please refresh the page and start again.";
    $err = $charge_id = "";
    $last4 = "N/A";
    $brand = "N/A (BONUS)";
    $exp_month = "N";
    $exp_year = "A";
    $transaction_currency = 'gbp';
    $chargeCreatedTime = time();
    \Debugbar::info($_POST);
    if ( ! Request::isMethod('post')) return;
    if( (! post('stripePrice') AND post('stripePrice') <> "0" ) OR ! post('stripeToken') OR ! post('stripeAmount') ){
        if($d) $err=" (err 1)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    }
    $stripeAmount =  post('stripeAmount');
    $stripePrice = post('stripePrice') * 100;
    if( ! isset($credit[$stripePrice]) OR $credit[$stripePrice]<>$stripeAmount){
        if($d) $err=" (err 2)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    }
    $stripeToken = post('stripeToken');

    \Debugbar::info(post(),"info:65");
    \Debugbar::info("stripeToken = $stripeToken","info:66");
    \Debugbar::info("stripeAmount = $stripeAmount");
    \Debugbar::info("stripePrice = $stripePrice");

    // Set your secret key: remember to change this to your live secret key in production
    // See your keys here https://dashboard.stripe.com/account/apikey

    if($stripePrice<>"0"):
    // Create the charge on Stripe's servers - this will charge the user's card
    try {
        \Stripe\Stripe::setApiKey($this_stripe_secret_key);
        $charge = \Stripe\Charge::create(array(
            "amount" => $stripePrice, // amount in cents, again
            "currency" => "gbp",
            "source" => $stripeToken,
            "metadata" => array(
                "user_company" => $user_company,
                "user_name" => $user_name,
                "user_surname" => $user_surname,
                "user_mail" => $user_email,
                "user_id" => $user_id,
            ),
            "description" => "Purchase of $stripeAmount OKTicK Advertising Credits")
        );

    }
    catch(\Stripe\Error\Api $e) {
        \Debugbar::info("Api = ".$e->getMessage());
        if($d) $err=" (err 3)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    }
    catch (\Stripe\Error\ApiConnection $e) {
        // Network communication with Stripe failed
        \Debugbar::info("ApiConnection = ".$e->getMessage());
        if($d) $err=" (err 4)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    } 
    catch (\Stripe\Error\Authentication $e) {
        // Authentication with Stripe's API failed
        \Debugbar::info("Authentication = ".$e->getMessage());
        if($d) $err=" (err 5)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    } 
    catch (\Stripe\Error\InvalidRequest $e) {
        // Display a very generic error to the user, and maybe send yourself an email
        \Debugbar::info("InvalidRequest = ".$e->getMessage());
        if($d) $err=" (err 6)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    } 
    catch (\Stripe\Error\RateLimit $e) {
        \Debugbar::info("RateLimit = ".$e->getMessage());
        if($d) $err=" (err 7)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    }
    catch (\Stripe\Error\Card $e) {
      // The card has been declined
        \Debugbar::info("Card = ".$e->getMessage());
        $error = "Sorry, your card was declined. Please refresh the page and start again, using another card";
        if($d) $err=" (err 8)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    } 
    if ($charge->paid <> true
//        OR $charge->livemode <> true
//        OR $charge->currency <> 'gbp' OR
//        $charge->amount <> $stripePrice
    ) {
        $error = "Sorry, your card was declined. Please refresh the page and start again, using another card";
        if($d) $err=" (err 9)";
        return (new Response('"'.$error.$err.'"', "402"))->header('Content-Type', "text/html; charset=UTF-8");
    } else {
        $charge_id = $charge->id;
        $chargeCreatedTime = $charge->created;
        $transaction_currency = $charge->currency;
        $last4 = $charge->source->last4;
        $brand = $charge->source->brand;
        $exp_month = $charge->source->exp_month;
        $exp_year = $charge->source->exp_year;
    }
    endif;
    DB::beginTransaction();
    \Debugbar::info($stripeAmount,"credits","info:116");
    $ok_credits = $user['ok_credits'] + $stripeAmount;
    DB::table('ok_payments')->insert(
                            array(
                                'company' => $user_company,
                                'user_id' => $user_id,
                                'transaction_date' => date( 'Y-m-d H:i:s', $chargeCreatedTime ),
                                'transaction_currency' => $transaction_currency,
                                'credits_purchased' => $stripeAmount,
                                'credits_total' => $ok_credits,
                                'price_paid' => $stripePrice,
                                'charge_id' => $charge_id,
                                'last4' => $last4,
                                'brand' => $brand,
                                'exp_month' => $exp_month,
                                'exp_year' => $exp_year,
                                'download_code' => Hash('sha512',$charge_id),
                                'created_at' => date( 'Y-m-d H:i:s', $chargeCreatedTime ),
                                'updated_at' => date( 'Y-m-d H:i:s', $chargeCreatedTime ),
                                )
    );
    DB::table('oktick.users')
    ->where('id', $user_id)
    ->update(array(
        'ok_credits' => $ok_credits,
        'ok_first_time_buyer' => 0,
    ));
    DB::commit();

    $Message = "Success! $stripeAmount Credits added. ";
    return (new Response('"'.$Message.'" %'.$ok_credits.'%', "200"))->header('Content-Type', "text/html; charset=UTF-8");
}
?>
==
{% partial "acc-pay-head" cssfile="oktick.css" %}
{% partial "nav-top" %}
<div class="container">
<h2 class="text-center">Credits and Offers{{"&nbsp;"|raw}}<span onclick="$('#credit-info1-plus').hide();$('#credit-info1').show();$.request('onInfo1On');" id="credit-info1-plus" class="text-primary glyphicon glyphicon-sm glyphicon glyphicon-info-sign {% if user.ok_help1_credit==1 %}collapse{%endif%}"></span></h2>

<div class="row select-product">
    <div class="col-xs-1"></div>
        <div class="col-xs-10">
        <div id="credit-info1" {% if user.ok_help1_credit==0 %}class="collapse"{% endif %} >
                <p>{{"&nbsp;&nbsp;&nbsp;"|raw}}</p>
                
                <p>Welcome! Below you find our introductory offers. Introductory offers are only valid the first time you add Credits. Subsequently our standard plans will be available to you.</p>
                <p>For first timers we offer our Ultralight package for FREE or DOUBLE the amount of Credits on any of our standard plans. Our gold plan is the best deal available because the price per credit is only £0.10 for the first time buyer.</p>
                <p>With Credits you elevate the listing position of your products and services. With one Credit/week per product, getting to the top or close to the top of the lists of providers of specific products and services is extremely economical.</p>
                <div class="text-center">
                    <button onclick="$('#credit-info1').hide();$('#credit-info1-plus').show();$.request('onInfo1Off');" class="btn btn-primary"><span class="glyphicon glyphicon glyphicon-thumbs-up"></span>&nbsp;Got it!</button>
                    <br>
                    <br>
                </div>
            </div>
        </div>
    <div class="col-xs-1"></div>
</div>
<br>
<br>
<div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-2">
        <div class="thumbnail payment_options_div" onclick="has_selected(1,event);">
            <img src="/app/ot/assets/img/50-1x200.png" alt="...">
            <div class="caption">
                <h3 class="text-center">Ultralight</h3>
                <!--span class="label label-success">POPULAR</span-->
                <p class="lead text-center">{{amount[1]}}<br>Credits<br>{%if initial %}FREE{% else %}£{{price[1]}}</p>{% endif %}
                <p class="text-center">
                    <a href="" class="btn btn-primary" onclick="has_selected(1,event);">Select</a>
                </p>
            </div>
        </div>
        {%if initial %}<p class="text-center">Free package<br>first time you<br>add credits.<br>Normally<br>{{iamount[1]}} Credits<br>£{{iprice[1]}}.</p>{% endif %}
    </div>
    <div class="col-md-2">
        <div class="thumbnail payment_options_div" onclick="has_selected(2,event);">
            <img src="/app/ot/assets/img/100-1x200.png" alt="...">
                <div class="caption">
                <h3 class="text-center">Bronze</h3>
                <p class="lead text-center">{{amount[2]}}<br>Credits<br>£{{price[2]}}</p>
                <p class="text-center">
                    <a href="" class="btn btn-primary" onclick="has_selected(2,event);">Select</a>
                </p>
            </div>
        </div>
        {%if initial %}<p class="text-center">Double value<br>first time you<br>add credits.<br>Normally<br>{{iamount[2]}} Credits<br>£{{iprice[2]}}.</p>{% endif %}
    </div>
    <div class="col-md-2">
        <div class="thumbnail payment_options_div" onclick="has_selected(3,event);">
            <img src="/app/ot/assets/img/250-1x200.png" alt="...">
            <div class="caption">
                <h3 class="text-center">Silver</h3>
                <p class="lead text-center">{{amount[3]}}<br>Credits<br>£{{price[3]}}</p>
                <p class="text-center">
                    <a href="" class="btn btn-primary" onclick="has_selected(3,event);">Select</a>
                </p>
            </div>
        </div>
        {%if initial %}<p class="text-center">Double value<br>first time you<br>add credits.<br>Normally<br>{{iamount[3]}} Credits<br>£{{iprice[3]}}.</p>{% endif %}
    </div>
    <div class="col-md-2">
        <div class="thumbnail payment_options_div" onclick="has_selected(4,event);">
            <img src="/app/ot/assets/img/500-1x200.png" alt="...">
                <div class="cnrflash">
                    <div class="cnrflash-inner">
                        <span class="cnrflash-label">Most<br>Popular</span>
                    </div>
                </div>
            <div class="caption">
                <h3 class="text-center">Gold</h3>
                <p class="lead text-center">{{amount[4]}}<br>Credits<br>£{{price[4]}}</p>
                <p class="text-center">
                    <a href="" class="btn btn-primary" onclick="has_selected(4,event);">Select</a>
                </p>
            </div>
        </div>
        {%if initial %}<p class="text-center">Double value<br>first time you<br>add credits.<br>Normally<br>{{iamount[4]}} Credits<br>£{{iprice[4]}}.</p>{% endif %}
    </div>
    <div class="col-md-2">
        <div class="thumbnail payment_options_div" onclick="has_selected(5,event);">
            <img src="/app/ot/assets/img/5000-1x200.png" alt="...">
            <div class="caption">
                <h3 class="text-center">Platinum</h3>
                <p class="lead text-center">{{amount[5]}}<br>Credits<br>£{{price[5]}}</p>
                <p class="text-center">
                    <a href="" class="btn btn-primary" onclick="has_selected(3,event);">Select</a>
                </p>
            </div>
        </div>
        {%if initial %}<p class="text-center">Double value<br>first time you<br>add credits.<br>Normally<br>{{iamount[5]}} Credits<br>£{{iprice[5]}}.</p>{% endif %}
    </div>
    <div class="col-md-1"></div>
</div>

<!-- Credit card form -->
<div class="row collapse" id="cc_product1">
    <div class="col-xs-0 col-md-2"></div>
    <div class="col-xs-12 col-md-8">
        {{ "&nbsp;<br>&nbsp;"|raw }}
        <div class="row">
            <div class="col-xs-0 col-md-2"></div>
            <div class="col-xs-12 col-md-8">
                <div class="panel panel-default">
                    <div class="panel-heading notfree" style="border:0">
                        <h3 class="panel-title"><img alt="" class="pull-right" src="/app/ot/assets/img/accepted_cc.png">Payment<br>Details</h3>
                    </div>
                    <div class="panel-heading" style="border:0">
                        <form action="" method="POST" id="payment-form">
                            <div class="row notfree">
                                <div class="col-xs-12 col-sm-4">
                                    <div class="form-group">
                                        <label for="cardType">CARD TYPE</label>
                                        <div class="input-group">
                                            <select class="form-control">
                                                <option>Visa Card</option>
                                                <option>Master Card</option>
                                                <option>Discover Card</option>
                                                <option>American Express</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12 col-sm-8">
                                    <div class="form-group">
                                        <label for="cardNumber">CARD NUMBER</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Valid Card Number" size="20" data-stripe="number" value="4242424242424242"/>
                                            <span class="input-group-addon"><i class="fa fa-credit-card"></i></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row notfree">
                                <div class="col-xs-7 col-md-7 pull-left">
                                    <div class="form-group">
                                        <label for="expMonth">EXPIRATION DATE</label>
                                        <div class="col-xs-6 col-lg-6 pl-ziro">
                                            <input type="text" class="form-control" placeholder="MM" size="2" data-stripe="exp_month" value="12"/>
                                        </div>
                                        <div class="col-xs-6 col-lg-6 pl-ziro">
                                            <input type="text" class="form-control" placeholder="YY" size="2" data-stripe="exp_year" value="16"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-5 col-md-5 pull-right">
                                    <div class="form-group">
                                        <label for="cvCode">CV CODE</label>
                                        <input type="txt" class="form-control" placeholder="CV" size="4" data-stripe="cvc" value="123"/>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <p class="payment-errors text-center collapse" id="payment-errors"></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12">
                                    <button class="btn btn-success btn-lg btn-block" id="pay_button" type="submit">Pay</button>
                                </div>
                            </div>
                            <input id="stripeAmount" type="hidden" name="stripeAmount" value=""/>
                            <input id="stripePrice" type="hidden" name="stripePrice" value=""/>
                            <input id="stripePrice" type="hidden" name="stripeToken" value=""/>
                        </form>
                    </div>
                    <div class="panel-heading notfree" style="border:0">
                        <h3 class="panel-title">
                            <img alt="" class="pull-left" src="/app/ot/assets/img/lock.png">
                            <img alt="" class="pull-right" src="/app/ot/assets/img/RapidSSL_SEAL.gif">
                            &nbsp;Secure credit card payment<br><small>&nbsp;This is a secure 128-bit SSL encrypted payment.</small>
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-xs-0 col-md-2"></div>
        </div>
    <div class="col-xs-0 col-md-2"></div>
</div>

</div><!--/container -->
{% partial "acc-nav-bottom" %}
{% partial "acc-pay-foot" %}