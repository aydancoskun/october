title = "Main"
url = "/:activationcode?"
layout = "main"
is_hidden = 0
==
<?php
function onInit(){
    $this['activationcode'] = $this->param('activationcode');
    if(!$this['activationcode']) return;
    $user_id = DB::table('users')->where('activation_code', $this['activationcode'])->pluck('id');
    if(!$user_id) return;
    $is_activated = DB::table('users')->where('id', $user_id)->pluck('is_activated');
    if($is_activated) return;
    DB::table('users')->where('id', $user_id)->update(['is_activated' => 1]);
    $username = DB::table('users')->where('id', $user_id)->pluck('username');
    $password = str_random(12);
    DB::table('users')->where('id', $user_id)->update(['password' => Hash::make($password)]);
    try{
        $user = Auth::authenticate(['password' => $password,'login'=>$username], true);
    } catch (Exception $e) {
        Flash::error("I'm sorry, Dave. I'm afraid I can't do that.".$e->getMessage());
        return redirect("/");
    }
    
    $user->password = $password;
    $user->password_confirmation = $password;
    $user->is_activated = 1;
    $user->activated_at = gmdate('Y-m-d H:i:s');
    $user->ok_unsubscribed_at = null;
    $user->ok_confirmed_at = gmdate('Y-m-d H:i:s');
    $user->save();
    Auth::login($user->reload(), true);


    try{
        DB::table('oktick.leancode_campaign_messages_subscribers')
            ->where('subscriber_id', $user->id)
            ->update(array('stop_at' => null,));
        DB::table('oktick.shahiemseymor_assigned_roles')
            ->where('user_id', $user->id)->delete();
        DB::table('oktick.shahiemseymor_assigned_roles')
            ->insert(array(
            'user_id' => $user->id,
            'role_id' => 3,
            'created_at'=>gmdate('Y-m-d H:i:s'),
    ));
        Flash::success("Welcome to OKTicK");
    } catch (Exception $e) {
        Flash::warning("Welcome to OKTicK");
    }
    return redirect("/".$this['activationcode']);
}
?>
==
{% partial "head" %}
{% partial "nav-top" %}
<div class="container">
    <div class="row"></div>
</div>
<div class="container">
    {% partial "logo-embeded-defered" %}
    <br>
    <div class="container">
        <div class="row"></div>
    </div>
    {% partial "search-section" datatype="Go!" %}
    <div class="container">
        <div class="row"></div>
    </div>
    <br>
    <div class="container">
        <div class="row"></div>
    </div>
    <div id="results-container"></div>
</div><!--/container -->
{% partial "nav-bottom" %}
{% partial "foot" %}